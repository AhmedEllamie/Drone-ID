@startuml Drone Takeoff Detection State Machine

[*] --> IDLE : System Start

state IDLE {
  [*] --> WaitingForMotor
  WaitingForMotor : Wait for motor start
  WaitingForMotor : Monitor for movement
  WaitingForMotor : Status: STOP
}

state MOTOR_ON {
  [*] --> MotorDetected
  MotorDetected : Motor detected
  MotorDetected : Wait for rising trend
  MotorDetected : Status: STOP
}

state FIRST_RISE {
  [*] --> RisingDetected
  RisingDetected : Rising trend detected
  RisingDetected : Wait for falling trend
  RisingDetected : Timeout: 5s
  RisingDetected : Status: STOP
}

state FIRST_FALL {
  [*] --> FirstFallingDetected
  FirstFallingDetected : First falling trend
  FirstFallingDetected : Wait for second fall
  FirstFallingDetected : Timeout: 5s
  FirstFallingDetected : Status: STOP
}

state SECOND_FALL {
  [*] --> SecondFallingDetected
  SecondFallingDetected : Second falling trend
  SecondFallingDetected : Wait for rise
  SecondFallingDetected : Timeout: 5s
  SecondFallingDetected : Status: STOP
}

state SECOND_RISE {
  [*] --> SecondRisingDetected
  SecondRisingDetected : Rising trend detected
  SecondRisingDetected : Complete pattern
  SecondRisingDetected : Status: STOP
}

state STEADY {
  [*] --> TakeoffDetected
  TakeoffDetected : Takeoff detected
  TakeoffDetected : Monitor for landing
  TakeoffDetected : Landing check: 10s
  TakeoffDetected : Status: START
}

' Main flow transitions
IDLE --> MOTOR_ON : Motor Detection\n(AZ/AX/AY > 0.04g OR GX/GY/GZ > 5.0 dps)
MOTOR_ON --> FIRST_RISE : Rising Trend\n(window[-1] > window[0] + 0.08g)
FIRST_RISE --> FIRST_FALL : Falling Trend\n(window[-1] < window[0] - 0.08g)
FIRST_FALL --> SECOND_FALL : Falling Trend\n(window[-1] < window[0] - 0.08g)
SECOND_FALL --> SECOND_RISE : Rising Trend\n(window[-1] > window[0] + 0.08g)
SECOND_RISE --> STEADY : Immediate Transition
STEADY --> IDLE : Landing Confirmed\n(10s idle condition)

' Reset conditions (all go back to IDLE)
IDLE --> IDLE : Large Threshold Exceeded
MOTOR_ON --> IDLE : Large Threshold Exceeded
FIRST_RISE --> IDLE : Large Threshold Exceeded
FIRST_FALL --> IDLE : Large Threshold Exceeded
SECOND_FALL --> IDLE : Large Threshold Exceeded
SECOND_RISE --> IDLE : Large Threshold Exceeded
STEADY --> IDLE : Large Threshold Exceeded

' Additional reset conditions
MOTOR_ON --> IDLE : Motor Stop\n(Total movement < 0.01g)
FIRST_RISE --> IDLE : Motor Stop\n(Total movement < 0.01g)
FIRST_RISE --> IDLE : Timeout\n(5s no falling trend)
FIRST_FALL --> IDLE : Timeout\n(5s no second falling trend)
SECOND_FALL --> IDLE : Timeout\n(5s no rising trend)

' Status annotations
note right of IDLE : Status: STOP
note right of MOTOR_ON : Status: STOP
note right of FIRST_RISE : Status: STOP
note right of FIRST_FALL : Status: STOP
note right of SECOND_FALL : Status: STOP
note right of SECOND_RISE : Status: STOP
note right of STEADY : Status: START

' Combined reset system note
note left of IDLE
    RESET SYSTEM
    • Large Threshold Exceeded
    • Excessive X/Y Movement
    • Motor Stop Detection
    • Excessive Rotation
    • Transition Timeout
    
    Actions:
    • State → IDLE
    • Status → STOP
    • Clear windows/timers
    • Increment reset counter
    
    THRESHOLD VALUES:
    • Motor Detection: 0.04g / 5.0 dps
    • Large Threshold (IDLE/MOTOR_ON): 1.5g / 100.0 dps
    • Large Threshold (Takeoff): 2.0g / 300.0 dps
    • Trend Margin: 0.08g
    • Landing Detection: 0.03g / 10.0 dps
    • Motor Stop: 0.01g total
    • Timeout: 5.0s
    • Landing Check: 10.0s
end note

@enduml 